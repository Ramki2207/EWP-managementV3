<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assign Random Creators to Projects</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #1a1d24;
      color: #e5e7eb;
    }
    .container {
      background: #2A303C;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    h1 {
      color: #60a5fa;
      margin-top: 0;
    }
    button {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    button:disabled {
      background: #4b5563;
      cursor: not-allowed;
      transform: none;
    }
    #log {
      background: #1a1d24;
      border: 1px solid #374151;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.5;
    }
    .log-entry {
      margin: 4px 0;
    }
    .success { color: #10b981; }
    .error { color: #ef4444; }
    .info { color: #60a5fa; }
    .warning { color: #f59e0b; }
    .summary {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #374151;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé≤ Assign Random Creators to Projects</h1>
    <p>This tool will randomly assign users as creators to all projects that don't have a creator assigned yet.</p>
    <p><strong>Warning:</strong> This is a one-time operation. Only run this if you want to populate the created_by field for existing projects.</p>

    <button id="assignBtn" onclick="assignCreators()">Start Assignment</button>

    <div id="log"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    // Get environment variables
    const supabaseUrl = import.meta.env?.VITE_SUPABASE_URL || 'YOUR_SUPABASE_URL';
    const supabaseKey = import.meta.env?.VITE_SUPABASE_ANON_KEY || 'YOUR_SUPABASE_ANON_KEY';

    if (!supabaseUrl || !supabaseKey || supabaseUrl === 'YOUR_SUPABASE_URL') {
      addLog('‚ùå Error: Supabase credentials not found. Please check your .env file.', 'error');
      document.getElementById('assignBtn').disabled = true;
    }

    const supabase = createClient(supabaseUrl, supabaseKey);

    function addLog(message, type = 'info') {
      const log = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = message;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }

    window.assignCreators = async function() {
      const btn = document.getElementById('assignBtn');
      btn.disabled = true;
      btn.textContent = 'Processing...';

      const log = document.getElementById('log');
      log.innerHTML = '';

      try {
        addLog('üîç Fetching all users...', 'info');
        const { data: users, error: usersError } = await supabase
          .from('users')
          .select('id, username');

        if (usersError) {
          addLog(`‚ùå Error fetching users: ${usersError.message}`, 'error');
          return;
        }

        if (!users || users.length === 0) {
          addLog('‚ùå No users found in database', 'error');
          return;
        }

        addLog(`‚úÖ Found ${users.length} users: ${users.map(u => u.username).join(', ')}`, 'success');

        addLog('üîç Fetching projects without creators...', 'info');
        const { data: projects, error: projectsError } = await supabase
          .from('projects')
          .select('id, project_number, created_by')
          .is('created_by', null);

        if (projectsError) {
          addLog(`‚ùå Error fetching projects: ${projectsError.message}`, 'error');
          return;
        }

        if (!projects || projects.length === 0) {
          addLog('‚úÖ All projects already have creators assigned!', 'success');
          return;
        }

        addLog(`üìä Found ${projects.length} projects without creators`, 'info');
        addLog('üé≤ Assigning random creators...', 'info');

        let successCount = 0;
        let errorCount = 0;

        for (const project of projects) {
          const randomUser = users[Math.floor(Math.random() * users.length)];

          addLog(`  - Project ${project.project_number}: Assigning to ${randomUser.username}`, 'info');

          const { error: updateError } = await supabase
            .from('projects')
            .update({ created_by: randomUser.id })
            .eq('id', project.id);

          if (updateError) {
            addLog(`    ‚ùå Error: ${updateError.message}`, 'error');
            errorCount++;
          } else {
            addLog(`    ‚úÖ Updated successfully`, 'success');
            successCount++;
          }

          // Small delay to avoid rate limiting
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        addLog('\nüìä Summary:', 'summary');
        addLog(`  ‚úÖ Successfully updated: ${successCount} projects`, 'success');
        if (errorCount > 0) {
          addLog(`  ‚ùå Failed: ${errorCount} projects`, 'error');
        }
        addLog('\n‚ú® Done! You can now close this page.', 'success');

      } catch (error) {
        addLog(`‚ùå Unexpected error: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Start Assignment';
      }
    };
  </script>
</body>
</html>
